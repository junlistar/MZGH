/*
门诊发药病人列表
*/
declare
  @startdate datetime,
  @enddate   datetime,
  @p_id      varchar(20),
  @group_no varchar(6),          
  @order_type  varchar(30),
  @windows_no varchar(3),
  @confirm integer --1取发药列表，0取退药列表
select @startdate=:price_data1,@enddate=:price_data2,@p_id=:patient_id,
       @group_no=:group_no,@order_type=:order_type,@windows_no=:windows_no,
       @confirm=:confirm
SELECT   a.patient_id,
         a.name,
         a.ledger_sn,
         a.charge_status,
         a.order_type,
         a.confirm_win,
         a.confirm_date,                                                                                
         a.windows_no,                         
         a.order_no,
         sum(a.charge_amount * a.charge_price * a.caoyao_fu) as charge
    into #patient     
FROM mz_detail_charge a  with (nolock) left join mz_detail_charge back  with (nolock)
     on a.patient_id=back.patient_id
      and a.times=back.times
      and a.order_type=back.order_type
      and a.order_no=back.order_no
      and a.item_no=back.item_no
      and a.ledger_sn >0
      and back.ledger_sn < 0
WHERE a.price_data >= @startdate AND a.price_data < @enddate
    and a.group_no   = @group_no
    and a.change_drug_code >=0
    and a.change_drug_code < 10 
    and a.charge_status ='4'
    and a.serial_no <> '**'
    and back.ledger_sn is null                                                           
group by 
         a.patient_id,
         a.name,
         a.ledger_sn,
         a.charge_status,
         a.order_type,
         a.confirm_win,
         a.confirm_date,
         a.windows_no,
         a.order_no
 if @p_id<>'%'
    delete #patient  where patient_id<>@p_id
 if @windows_no<>'%'
    delete #patient  where windows_no<>@windows_no
 if @confirm=1
    delete #patient where not confirm_date is null --去掉已经发药的
  else
    delete #patient where confirm_date is null     --去掉为发药

 select  a.patient_id,a.name,b.p_bar_code,a.ledger_sn,sum(charge) as charge ,count(order_no) order_sl
 from #patient a left join  mz_patient_mi b on a.patient_id=b.patient_id
 group by a.patient_id,a.name,b.p_bar_code,a.ledger_sn
 order by 2
 drop table  #patient
