
/*
 
药品出库保存校验 cx：2022-09-26
 
 */   
create  proc [dbo].[yp_ypOutSaveCheck] @group_no_out varchar(10), @draw_no int, @out_date datetime,@plan_PageNo varchar(200)
as
begin
 declare @serial int,@ErrMsg varchar(200),@group_no_in varchar(10)
 SET NOCOUNT on
 set xact_abort on
 begin try
   begin tran
   select *
   into #outDetl
   from yp_out_detl
   where draw_no=@draw_no and out_date=@out_date
   select top 1 @group_no_in=group_no_in from #outDetl
   if exists(select charge_code,COUNT(1) from #outDetl 
      group by charge_code
      having (COUNT(1) >1) )
   begin
     set @ErrMsg=''
     select @ErrMsg=@ErrMsg+ charge_code +',' 
     from #outDetl
     where charge_code in(select charge_code  from #outDetl 
      group by charge_code
      having (COUNT(1) >1) )
      set @ErrMsg=@ErrMsg++' 药品重复' 
      raiserror(@ErrMsg ,11,2)
   end
   
   select *
   into #pageno
   from dbo.fn_SplitStr2(@plan_PageNo,'1')
   update yp_in_plan set flag = '1'
   where page_no in(select t from #pageno ) and group_no_in=@group_no_in 
   commit tran

   SET NOCOUNT OFF  
   set xact_abort off    
  End Try
  begin catch
    declare  @strErr varchar(200)
    select @strErr=ERROR_MESSAGE()  
    raiserror (@strErr,11,2)    
    rollback tran
  end catch
end      
