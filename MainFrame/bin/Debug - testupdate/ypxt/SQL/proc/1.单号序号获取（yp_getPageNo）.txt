
/*
 
药品系统获取单号 cx：2022-08-18
 declare @page int
 exec [yp_getPageNo] 'maxcharge_code',@page output
 select @page   
 */   
alter  proc [dbo].[yp_getPageNo] @PageName varchar(20), @PageNo int output
as
begin
 declare @serial int,@ErrMsg varchar(200)
 SET NOCOUNT on
 set xact_abort on
 begin try
   begin tran
   if @PageName= 'out_pageno'
   begin
	   select @serial =out_pageno 
	   from yp_configure
	   update yp_configure
	   set out_pageno=isnull(@serial,0)+1 
	   where out_pageno=@serial
	   if @@ROWCOUNT <>1 
		 raiserror('更新单号配置失败!!',11,2)                   
   end else
   if @PageName= 'in_pageno'
   begin
	   select @serial =in_pageno 
	   from yp_configure
	   update yp_configure
	   set in_pageno=isnull(@serial,0)+1 
	   where in_pageno=@serial
	   if @@ROWCOUNT <>1 
		 raiserror('更新单号配置失败!!',11,2)                   
   
   end else
   if @PageName= 'plan_pageno'
   begin
	   select @serial =plan_pageno 
	   from yp_configure
	   update yp_configure
	   set plan_pageno=isnull(@serial,0)+1 
	   where plan_pageno=@serial
	   if @@ROWCOUNT <>1 
		 raiserror('更新单号配置失败!!',11,2)                   
   
   end else
   if @PageName= 'hz_pageno'
   begin
	   select @serial =hz_pageno 
	   from yp_configure
	   update yp_configure
	   set hz_pageno=isnull(@serial,0)+1 
	   where hz_pageno=@serial
	   if @@ROWCOUNT <>1 
		 raiserror('更新单号配置失败!!',11,2)                     
   end else
   if @PageName='maxcharge_code' 
   begin
	   select @serial =maxcharge_code 
	   from yp_configure
	   update yp_configure
	   set maxcharge_code=isnull(@serial,0)+1 
	   where maxcharge_code=@serial
	   if @@ROWCOUNT <>1 
		 raiserror('更新maxcharge_code配置失败!!',11,2) 
   end
   else    
   begin
     set @ErrMsg= '参数【' + @PageName +'】只能是{out_pageno，in_pageno，plan_pageno，hz_pageno}!!'
     raiserror(@ErrMsg,11,2)   
   end     
   commit tran
   select @PageNo=@serial+1
   SET NOCOUNT OFF  
   set xact_abort off    
  End Try
  begin catch
    declare  @strErr varchar(200)
    select @strErr=ERROR_MESSAGE()  
    raiserror (@strErr,11,2)    
    rollback tran
  end catch
end      
